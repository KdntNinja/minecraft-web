<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Webcraft</title>
    <script defer data-domain="webcraft.kdnsite.site" src="http://plausible.kdnsite.site/js/script.js"></script>
</head>
<body>
    <div id="loading-screen">
        <div id="loading-title">Webcraft</div>
        <div id="loading-percentage">0%</div>
        <div id="loading-bar-container">
            <div id="loading-bar"></div>
        </div>
        <div id="loading-stage">Downloading</div>
        <div id="loading-message">Fetching game files...</div>
        <div id="loading-spinner"></div>
        <div id="loading-logs"></div>
    </div>
    <script src="wasm_exec.js"></script>
    <script>
        // --- Initial UI Setup ---
        const spinner = document.getElementById('loading-spinner');
        const logContainer = document.getElementById('loading-logs');
        if (spinner) spinner.style.display = 'block';
        if (logContainer) logContainer.style.display = 'none';

        let logEntries = [];
        let lastUpdateTime = 0;
        const UPDATE_THROTTLE = 50; // Minimum ms between UI updates
        
        // Capture console.log and add to loading logs
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.join(' ');
            addLogEntry(message);
        };
        
        function addLogEntry(message) {
            // On first log, hide spinner and show log container
            if (logContainer && logContainer.style.display === 'none') {
                if (spinner) spinner.style.display = 'none';
                logContainer.style.display = 'block';
            }

            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            // Style different types of log messages
            if (message.includes('[PROGRESS]')) {
                logEntry.className += ' progress';
                
                // Parse progress from the message and update UI immediately
                // Format: [PROGRESS] Stage: Message (percentage%)
                const progressMatch = message.match(/\[PROGRESS\]\s+([^:]+):\s+([^(]+)\s+\((\d+)%\)/);
                if (progressMatch) {
                    const [, stage, msg, percentage] = progressMatch;
                    updateLoadingProgressThrottled(parseInt(percentage), stage, msg.trim());
                }
            } else if (message.includes('DEBUG:')) {
                logEntry.className += ' debug';
            }
            
            logEntry.textContent = new Date().toLocaleTimeString() + ' ' + message;
            logContainer.appendChild(logEntry);
            
            // Auto-scroll to bottom
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Keep only last 50 log entries
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }
        
        // Throttled version to prevent too frequent updates
        function updateLoadingProgressThrottled(percentage, stage, message) {
            const now = performance.now();
            if (now - lastUpdateTime < UPDATE_THROTTLE && percentage < 100) {
                return; // Skip update if too soon (unless it's 100%)
            }
            lastUpdateTime = now;
            updateLoadingProgressInternal(percentage, stage, message);
        }
        
        // Global function to update loading progress (called from Go)
        window.updateLoadingProgress = function(percentage, stage, message) {
            // Direct call from Go - no throttling needed
            updateLoadingProgressInternal(percentage, stage, message);
        };
        
        // Internal function that actually updates the UI
        function updateLoadingProgressInternal(percentage, stage, message) {
            const loadingScreen = document.getElementById('loading-screen');
            const percentageEl = document.getElementById('loading-percentage');
            const barEl = document.getElementById('loading-bar');
            const stageEl = document.getElementById('loading-stage');
            const messageEl = document.getElementById('loading-message');
            
            const displayPercentage = Math.min(100, Math.round(percentage));

            if (percentageEl) percentageEl.textContent = displayPercentage + '%';
            if (barEl) {
                barEl.style.width = percentage + '%';
                // Force a reflow to ensure the transition happens
                barEl.offsetHeight;
            }
            if (stageEl) stageEl.textContent = stage;
            if (messageEl) messageEl.textContent = message;
            
            // Ensure UI updates are immediately visible
            if (loadingScreen) {
                loadingScreen.offsetHeight; // Force reflow
            }
            
            if (percentage >= 100) {
                console.log('Loading complete! Hiding loading screen...');
                // Show spinner while finalizing
                const spinner = document.getElementById('loading-spinner');
                if (spinner) spinner.style.display = 'block';
                
                // Hide loading screen after a brief delay
                setTimeout(() => {
                    if (loadingScreen) {
                        loadingScreen.style.display = 'none';
                        console.log('Loading screen hidden successfully');
                    } else {
                        console.error('Loading screen element not found!');
                    }
                }, 1000);
            }
        }
        
        const go = new Go();
        WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject).then((result) => {
            addLogEntry('Starting WebAssembly module...');
            go.run(result.instance);
        }).catch(err => {
            addLogEntry('Error loading WebAssembly: ' + err.message);
            console.error('Failed to load WebAssembly:', err);
        });
    </script>
    <canvas id="game-canvas"></canvas>
</body>
</html>

<style>
    html, body {
        width: 100vw;
        height: 100vh;
        margin: 0;
        padding: 0;
        background: #000;
        overflow: hidden;
        position: fixed;
        top: 0;
        left: 0;
    }
    #game-canvas {
        display: block;
        width: 100vw;
        height: 100vh;
        background: #000;
    }
    #loading-screen {
        position: fixed;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        background: #000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    #loading-title {
        color: #4caf50;
        font-size: 3em;
        font-weight: bold;
        margin-bottom: 20px;
        text-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
    }
    
    #loading-bar-container {
        width: 400px;
        height: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 20px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    #loading-bar {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #81c784);
        transition: width 0.3s ease;
        box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    }
    
    #loading-percentage {
        color: #fff;
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    #loading-stage {
        color: #4caf50;
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 10px;
        min-height: 1.5em;
    }
    
    #loading-message {
        color: #ccc;
        font-size: 1em;
        margin-bottom: 20px;
        min-height: 1.2em;
    }
    
    #loading-logs {
        width: 600px;
        max-width: 90vw;
        height: 200px;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 8px;
        padding: 15px;
        overflow-y: hidden;
        border: 1px solid rgba(76, 175, 80, 0.3);
    }
    
    .log-entry {
        color: #ddd;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        margin-bottom: 2px;
        line-height: 1.3;
    }
    
    .log-entry.debug {
        color: #888;
    }
    
    .log-entry.progress {
        color: #4caf50;
        font-weight: bold;
    }
    
    #loading-spinner {
        display: none;
        width: 40px;
        height: 40px;
        border: 4px solid rgba(76, 175, 80, 0.3);
        border-top: 4px solid #4caf50;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-top: 5px;
        margin-bottom: 30px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>